name: Build and Release APK

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Get dependencies
        working-directory: memos_flutter_app
        run: flutter pub get

      - name: Decode keystore
        working-directory: memos_flutter_app/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ] || [ -z "${ANDROID_KEYSTORE_PASSWORD:-}" ] || [ -z "${ANDROID_KEY_PASSWORD:-}" ] || [ -z "${ANDROID_KEY_ALIAS:-}" ]; then
            echo "Keystore secrets missing; skip decode."
            exit 0
          fi
          mkdir -p app/keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/keystore/release.jks

      - name: Create key.properties
        working-directory: memos_flutter_app/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ] || [ -z "${ANDROID_KEYSTORE_PASSWORD:-}" ] || [ -z "${ANDROID_KEY_PASSWORD:-}" ] || [ -z "${ANDROID_KEY_ALIAS:-}" ]; then
            echo "Keystore secrets missing; skip key.properties."
            exit 0
          fi
          cat > key.properties <<'EOF'
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyPassword=${ANDROID_KEY_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          storeFile=keystore/release.jks
          EOF

      - name: Build APK
        working-directory: memos_flutter_app
        run: flutter build apk --release --no-tree-shake-icons

      - name: Rename release APK
        working-directory: memos_flutter_app
        run: |
          set -euo pipefail
          version=$(awk '/^version:/ {print $2; exit}' pubspec.yaml)
          version=${version%%+*}
          src="build/app/outputs/flutter-apk/app-release.apk"
          if [ ! -f "$src" ]; then
            src=$(find build/app/outputs -type f -name "*release*.apk" | head -n 1 || true)
          fi
          if [ -z "$src" ] || [ ! -f "$src" ]; then
            echo "Release APK not found under build/app/outputs" >&2
            exit 1
          fi
          dest="build/app/outputs/flutter-apk/MemoFlow_v${version}-release.apk"
          mkdir -p "$(dirname "$dest")"
          cp "$src" "$dest"
          echo "APK copied to $dest"

      - name: Create release and upload APK
        uses: ncipollo/release-action@v1
        with:
          artifacts: "memos_flutter_app/build/app/outputs/**/MemoFlow_v*-release.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          generateReleaseNotes: true
